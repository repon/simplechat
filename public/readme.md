# チャットサーバ＆チャットソフト
2013.6.28 repon

Sinatraで、データをjsonpでやり取りするチャットサーバを作り、クライアントをAngularJSで作りました。
習作ですが、使えれば使って行きたいです。

## 作成の動機

サバイブで動いているのが現在チャットルームのみで、それならログをさかのぼれるチャットルームを作ったほうがいいだろうと思っていたので。
マルチデバイス対応にしたかった。というか、待ち合わせとかでは、チャットをスマートフォンで読み書きできないと結構ストレスなので。

## 動作

クライアントは一応、PCブラウザでもスマートフォンのブラウザでも動きます。

## なぜSinatraとAngularJSなのか

* データをjson形式でやり取りすれば、サーバでもクライアントでも、好きなように作れると思い、まずjsonでデータをやり取りしたい、と思いました。

* サーバ側はSinatraで行くことにしました。自分の必要な作業でURLルーティングが必要となり、一番とっつきやすそうなものがSinatraで、ある程度触ったので。Railsなどは触れてないです。
* サーバはSinatra+Sequel+Passengerです。

* クライアント側は、jsonデータをjQueryでDOMを組んでいくことに大きく負担を感じ、フレームワークを探してみたところ、AngularJSが使いやすそうだったので、作ってみました。実際使いやすかったです。
* クライアントはhaml+jQuery+AngularJS+TwitterBootstrapです。Bootstrapでリキッドデザインだぜイェーと思って作ったのですが、崩れる崩れる……

## 説明

ここで本来「仕様」を書くのでしょうが、書き方がわからないため、メモになります。すみません。

#### サーバについて

1. サーバは、URLに接続するとjsonp形式のデータを返します。
1. `baseurl/count?callback=callback`で、チャットの発言数を`callback({"cnt":18})`といった形式で返します。
1. baseurl/getで、チャットの発言を取得出来ます。発言は新しい順に並べられています。パラメータ`size`で取得したい発言数を、パラメータ`offset`で最初からoffset番目以降のデータを取り出します。リクエスト形式は`baseurl/get?callback=callback&size=5&offset=5`といった形式になり、`callback([{"id":1,"member":"repon","data":"ohayo","create_at":"2013-06-29 11:23:09"}])`といったデータを返します。
1. baseurl/postで、チャットに発言できます。メソッドは`get`です（`post`ではありません……jsonpでpostをやる方法が、jQueryなどでもわからず、失敗ばかりだったので`get`に日和りました）。パラメータ`member`で名前を、パラメータ`data`で発言を送信出来ます。コールバックとして、発言のidが返ってきます。

#### クライアントについて

1. iPhoneで見やすいものをと作ったのですが、名前と時間が並ばず、上下になってしまっていますね……
1. 発言はすぐ反映します。
1. 認証は付けていません。名前も自分で書きます。

## ソースの公開について

ソースは知人やサバイブで限定公開します。
http://chat.reponlabo.info/chatapp.zip
です。
知人やサバイブでソースを見てもらって、使えそうなら道具として使えればと思います。
それと、SinatraとSequelとAngularJSとhamlの、わずかながらの実践となっているので、見ていただければ。
hamlはrubyが必要ですが、コード量が少なくて済むので重宝しています。
javascriptのフレームワークはDomを極力触らないで済むので、ミスも少なくなると思います。AngularJSのページは英語ですが、ドットインストールでチュートリアルやって、本家サイトに行くと例が豊富なので、だいたいやりたいことが書いてありました。
XSS対策とか、ほとんど調べていないので、多分ヤバイのではないかという気はします。
リファクタリングしないと、中味がよくわからないかも。でも動く。

## 今後

* CRUDのupdateとdeleteも付いてないですし、そのためには認証も必要ですがまだ調べられていません（サーバとクライアントの認証、サーバとクライアントのセッション、それぞれ）。
* iPhoneで見られるもの、と思ったのに、崩れています。どうしたものか。
* 使うとしたら、どこにクライアントを公開しましょうか。現在は ` http://chat.reponlabo.info/chat.html ` にあります。
* サーバの機能拡張なども、Sinatraは簡単にできるので（自由すぎてむしろ混乱が起きやすい）、随時追加していけば使えるものになるかもしれないです。

以上。